<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>INNFERNOS | Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #111;
      --text: #f5f5f5;
      --muted: #bdbdbd;
      --accent: #ff5733;
      --link: #ffa500;
      --nav: #0ff;
      --row: #1a1a1a;
      --row-alt: #161616;
      --border: #2a2a2a;
      --hover: #202020;
      --panel: #131313;
      --head: #151515;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 2rem;
      line-height: 1.45;
    }
    a { color: var(--link); text-decoration: none; }
    a:hover { text-decoration: underline; }
    h1 { font-size: 1.6rem; margin: 0 0 10px; color: var(--accent); }

    nav { margin: 0 0 1.5rem; }
    nav a { margin-right: 1rem; color: var(--nav); font-weight: 800; }
    nav a:hover { text-decoration: underline; }

    .wrap { max-width: 980px; margin: 0 auto; }

    .toolbar {
      margin: 12px 0 16px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--panel);
    }

    button, select, input {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #181818;
      color: var(--text);
      outline: none;
    }
    button { cursor: pointer; font-weight: 700; }
    button:hover { background: var(--hover); }
    button:disabled { opacity: .6; cursor: not-allowed; }

    select, input { font-weight: 600; }
    input::placeholder { color: #8b8b8b; }

    #statusWrap { display: inline-flex; align-items: center; gap: 8px; }
    #status { font-size: 0.95rem; color: var(--muted); }
    #lastUpdated { margin-left: auto; font-size: 0.9rem; color: var(--muted); }

    .spinner {
      width: 16px; height: 16px;
      border: 2px solid #666;
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
      display: none;
    }
    .loading .spinner { display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 980px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    thead th {
      text-align: left;
      font-weight: 800;
      padding: 12px 10px;
      background: var(--head);
      border-bottom: 1px solid var(--border);
    }
    tbody td { padding: 10px; border-bottom: 1px solid var(--border); }
    tbody tr:nth-child(odd) { background: var(--row); }
    tbody tr:nth-child(even) { background: var(--row-alt); }
    tbody tr:hover { background: var(--hover); }

    .num { text-align: right; }
    .muted { color: var(--muted); }
    .pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      color: rgba(245,245,245,0.9);
      font-size: 0.85rem;
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <nav>
      <a href="./index.html">Roadmap</a>
      <a href="./leaderboard.html">Leaderboard</a>
    </nav>

    <h1>Innfernos Top Holders</h1>
    <div class="muted" style="margin-bottom: 10px;">
      Collection: <span class="pill" id="pillCollection"></span>
      Template: <span class="pill" id="pillTemplate"></span>
    </div>

    <div class="toolbar" id="lb-controls">
      <button id="refreshBtn">Refresh</button>
      <button id="csvBtn" disabled>Download CSV</button>

      <label class="muted" style="display:flex; align-items:center; gap:8px;">
        Show
        <select id="showCount">
          <option value="25">Top 25</option>
          <option value="50">Top 50</option>
          <option value="100" selected>Top 100</option>
        </select>
      </label>

      <input id="searchWallet" type="text" placeholder="Search wallet‚Ä¶" />

      <span id="statusWrap">
        <span class="spinner" id="spinner" aria-hidden="true"></span>
        <span id="status">Loading‚Ä¶</span>
      </span>

      <span id="lastUpdated"></span>
    </div>

    <table id="leaderboard">
      <thead>
        <tr>
          <th style="width: 80px;">Rank</th>
          <th>Wallet</th>
          <th class="num" style="width: 180px;">Innfernos Held</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="3" class="muted">Loading‚Ä¶</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    // ==========================
    // EASY DROP-IN CONFIG
    // ==========================
    const CONFIG = {
      collection: "inn",        // <-- your collection name
      templateId: "895730",     // <-- template id for the Innfernos NFT
      topDefault: 100,
      // accounts endpoint returns holders counts already aggregated (fast)
      endpoints: [
        "https://atomicassets.ledgerwise.io/atomicassets/v1",
        "https://wax.api.atomicassets.io/atomicassets/v1",
        "https://aa.dapplica.io/atomicassets/v1",
        "https://aa.wax.blacklusion.io/atomicassets/v1",
        "https://api-wax-aa.eosarabia.net/atomicassets/v1",
        "https://wax-aa.eu.eosamsterdam.net/atomicassets/v1",
      ],
      // common bot/contract wallets you may want excluded
      blacklist: [
        "waxdaofarmer", "waxdaomarket", "wombatmaster", "nfthivepacks",
        "blend.nefty", "swap.taco", "scurvybot.gm", "swap.alcor",
        "neftyblocksp", "neftyblocksd", "wallet.taco", "waxportalbot",
        "dig.sb"
      ],
      pageLimit: 1000,
      maxPages: 25,
      timeoutMs: 25000
    };

    // ==========================
    // STATE
    // ==========================
    let rawRows = [];   // {account, assets, collections?}
    let csvRows = null; // [ [wallet, count], ... ]
    let activeEndpoint = null;

    // ==========================
    // DOM
    // ==========================
    const els = {
      tbody: () => document.querySelector("#leaderboard tbody"),
      refreshBtn: () => document.getElementById("refreshBtn"),
      csvBtn: () => document.getElementById("csvBtn"),
      status: () => document.getElementById("status"),
      spinner: () => document.getElementById("spinner"),
      lastUpdated: () => document.getElementById("lastUpdated"),
      controls: () => document.getElementById("lb-controls"),
      showCount: () => document.getElementById("showCount"),
      searchWallet: () => document.getElementById("searchWallet"),
      pillCollection: () => document.getElementById("pillCollection"),
      pillTemplate: () => document.getElementById("pillTemplate"),
    };

    function setStatus(text) {
      const s = els.status(); if (s) s.textContent = text || "";
    }
    function setLoading(on) {
      const wrap = els.controls();
      const sp = els.spinner();
      if (wrap) wrap.classList.toggle("loading", !!on);
      if (sp) sp.style.display = on ? "inline-block" : "none";
    }
    function setLastUpdated(date) {
      const el = els.lastUpdated();
      if (!el) return;
      if (!date) { el.textContent = ""; return; }
      const ts = date.toLocaleString(undefined, {
        year:"numeric", month:"short", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      });
      el.textContent = `Last updated: ${ts}`;
    }

    // ==========================
    // FETCH
    // ==========================
    async function fetchJsonWithTimeout(url, timeoutMs) {
      const ctl = new AbortController();
      const t = setTimeout(() => ctl.abort(), timeoutMs);
      try {
        const res = await fetch(url, { signal: ctl.signal, cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } finally {
        clearTimeout(t);
      }
    }

    function buildAccountsUrl(base, page) {
      const qs = new URLSearchParams({
        collection_name: CONFIG.collection,
        template_id: CONFIG.templateId,
        page: String(page),
        limit: String(CONFIG.pageLimit),
        order: "desc",
        sort: "assets"
      }).toString();
      return `${base}/accounts?${qs}`;
    }

    async function pickWorkingEndpoint() {
      for (const base of CONFIG.endpoints) {
        try {
          setStatus(`Checking ${new URL(base).host}‚Ä¶`);
          const testUrl = buildAccountsUrl(base, 1);
          const json = await fetchJsonWithTimeout(testUrl, CONFIG.timeoutMs);
          if (Array.isArray(json?.data)) {
            activeEndpoint = base;
            setStatus(`Using ${new URL(base).host}`);
            return json; // first page
          }
        } catch (e) {
          console.warn("Endpoint failed:", base, e?.message || e);
        }
      }
      throw new Error("All AtomicAssets endpoints failed.");
    }

    async function fetchAllAccountPages() {
      const firstPage = await pickWorkingEndpoint();

      const all = [];
      let page = 1;

      while (page <= CONFIG.maxPages) {
        const json = page === 1
          ? firstPage
          : await fetchJsonWithTimeout(buildAccountsUrl(activeEndpoint, page), CONFIG.timeoutMs);

        const rows = Array.isArray(json?.data) ? json.data : [];
        if (!rows.length) break;

        all.push(...rows);

        if (rows.length < CONFIG.pageLimit) break;
        page++;
      }

      return all;
    }

    // ==========================
    // FILTER + RENDER
    // ==========================
    function normalizeWallet(w) {
      return String(w || "").trim().toLowerCase();
    }

    function getFilteredSortedRows() {
      const topN = Number(els.showCount()?.value || CONFIG.topDefault);
      const q = normalizeWallet(els.searchWallet()?.value);

      const filtered = (rawRows || [])
        .filter(r => r?.account && Number(r.assets) > 0)
        .filter(r => !CONFIG.blacklist.includes(normalizeWallet(r.account)))
        .filter(r => !q || normalizeWallet(r.account).includes(q))
        .sort((a, b) => Number(b.assets) - Number(a.assets))
        .slice(0, topN);

      return filtered;
    }

    function render() {
      const tbody = els.tbody();
      if (!tbody) return;

      const rows = getFilteredSortedRows();
      tbody.innerHTML = "";

      if (!rows.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="3" class="muted">No holders found (or filtered out).</td>`;
        tbody.appendChild(tr);
        els.csvBtn().disabled = true;
        csvRows = null;
        return;
      }

      rows.forEach((r, i) => {
        const wallet = r.account;
        const count = Number(r.assets) || 0;

        let medal = "";
        if (i === 0) medal = "üëë ";
        else if (i === 1) medal = "ü•à ";
        else if (i === 2) medal = "ü•â ";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${medal}${i + 1}</td>
          <td><a href="https://wax.atomichub.io/explorer/account/${wallet}" target="_blank" rel="noopener">${wallet}</a></td>
          <td class="num">${count}</td>
        `;
        tbody.appendChild(tr);
      });

      // build CSV data from the currently displayed rows
      csvRows = rows.map(r => [r.account, Number(r.assets) || 0]);
      els.csvBtn().disabled = false;
    }

    // ==========================
    // ACTIONS
    // ==========================
    async function loadLeaderboard() {
      const btn = els.refreshBtn();
      try {
        if (btn) { btn.disabled = true; btn.textContent = "Refreshing‚Ä¶"; }
        els.csvBtn().disabled = true;

        setLoading(true);
        setLastUpdated(null);
        setStatus("Loading leaderboard‚Ä¶");

        rawRows = await fetchAllAccountPages();

        setStatus("Ready");
        setLastUpdated(new Date());

        render();
      } catch (err) {
        console.error(err);
        setStatus("Error loading leaderboard. Click Refresh or hard refresh the page.");
        const tbody = els.tbody();
        if (tbody) {
          tbody.innerHTML = `<tr><td colspan="3" class="muted">‚ùå ${String(err.message || err)}</td></tr>`;
        }
      } finally {
        setLoading(false);
        if (btn) { btn.disabled = false; btn.textContent = "Refresh"; }
      }
    }

    function downloadCSV() {
      if (!csvRows || !csvRows.length) return;

      let csv = "Rank,Wallet,Innfernos Held\n";
      csvRows.forEach(([wallet, count], i) => {
        csv += `${i + 1},${wallet},${count}\n`;
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement("a"), {
        href: url,
        download: "innfernos_leaderboard.csv"
      });
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ==========================
    // INIT
    // ==========================
    document.addEventListener("DOMContentLoaded", () => {
      // show config pills
      const pc = els.pillCollection(); if (pc) pc.textContent = CONFIG.collection;
      const pt = els.pillTemplate();   if (pt) pt.textContent = CONFIG.templateId;

      // wire events
      els.refreshBtn()?.addEventListener("click", loadLeaderboard);
      els.csvBtn()?.addEventListener("click", downloadCSV);
      els.showCount()?.addEventListener("change", render);
      els.searchWallet()?.addEventListener("input", () => {
        // small debounce feel without timers
        render();
      });

      loadLeaderboard();
    });
  </script>
</body>
</html>

