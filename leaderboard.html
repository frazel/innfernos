<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>INNFERNOS | Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #111;
      --text: #f5f5f5;
      --muted: #bdbdbd;
      --accent: #ff5733;
      --link: #ffa500;
      --nav: #0ff;
      --row: #1a1a1a;
      --row-alt: #161616;
      --border: #2a2a2a;
      --hover: #202020;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0; padding: 2rem;
    }
    a { color: var(--link); text-decoration: none; }
    a:hover { text-decoration: underline; }
    h1 { font-size: 1.6rem; margin: 0 0 10px; color: var(--accent); }

    nav { margin: 0 0 1.5rem; }
    nav a { margin-right: 1rem; color: var(--nav); font-weight: 700; }
    nav a:hover { text-decoration: underline; }

    .toolbar { margin: 12px 0 16px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    button {
      padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px;
      background: #181818; color: var(--text); cursor: pointer;
    }
    button:hover { background: var(--hover); }
    button:disabled { opacity: .6; cursor: not-allowed; }

    #statusWrap { display: inline-flex; align-items: center; gap: 8px; }
    #status { font-size: 0.95rem; color: var(--muted); }
    #lastUpdated { margin-left: auto; font-size: 0.9rem; color: var(--muted); }

    .spinner {
      width: 16px; height: 16px; border: 2px solid #666; border-top-color: #fff;
      border-radius: 50%; animation: spin 0.9s linear infinite; display: none;
    }
    .loading .spinner { display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    table { border-collapse: collapse; width: 100%; max-width: 900px; background: #131313; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
    thead th {
      text-align: left; font-weight: 700; padding: 12px 10px;
      background: #151515; border-bottom: 1px solid var(--border);
    }
    tbody td { padding: 10px; border-bottom: 1px solid var(--border); }
    tbody tr:nth-child(odd) { background: var(--row); }
    tbody tr:nth-child(even) { background: var(--row-alt); }
    tbody tr:hover { background: var(--hover); }
    .num { text-align: right; }
    .muted { color: var(--muted); }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Roadmap</a>
    <a href="leaderboard.html">Leaderboard</a>
  </nav>

  <h1>Innfernos Top Holders</h1>

  <div class="toolbar" id="lb-controls">
    <button id="refreshBtn">Refresh</button>
    <button id="csvBtn">Download CSV</button>
    <span id="statusWrap">
      <span class="spinner" id="spinner" aria-hidden="true"></span>
      <span id="status">Loading…</span>
    </span>
    <span id="lastUpdated"></span>
  </div>

  <table id="leaderboard">
    <thead>
      <tr>
        <th style="width: 80px;">Rank</th>
        <th>Wallet</th>
        <th class="num" style="width: 160px;">Innfernos Held</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="3" class="muted">Loading…</td></tr>
    </tbody>
  </table>

  <script>
  // === Config ===
  const templateId = '895730';
  const collection = 'inn';

  // AtomicAssets mirrors to try in order
  const endpoints = [
    'https://atomicassets.ledgerwise.io/atomicassets/v1',
    'https://aa.dapplica.io/atomicassets/v1',
    'https://aa.wax.blacklusion.io/atomicassets/v1',
    'https://api-wax-aa.eosarabia.net/atomicassets/v1',
    'https://wax-aa.eu.eosamsterdam.net/atomicassets/v1',
    'https://wax.api.atomicassets.io/atomicassets/v1'
  ];

  const PAGE_LIMIT = 1000;   // large pages to reduce roundtrips
  const MAX_PAGES  = 100;    // safety cap
  let csvData = null;

  // === DOM helpers ===
  const els = {
    tbody:       () => document.querySelector('#leaderboard tbody'),
    refreshBtn:  () => document.getElementById('refreshBtn'),
    csvBtn:      () => document.getElementById('csvBtn'),
    status:      () => document.getElementById('status'),
    spinner:     () => document.getElementById('spinner'),
    lastUpdated: () => document.getElementById('lastUpdated'),
    controls:    () => document.getElementById('lb-controls'),
  };

  function setStatus(text) {
    const s = els.status(); if (s) s.textContent = text || '';
  }
  function setLoading(on) {
    const wrap = els.controls();
    const sp = els.spinner();
    if (wrap) wrap.classList.toggle('loading', !!on);
    if (sp) sp.style.display = on ? 'inline-block' : 'none';
  }
  function setLastUpdated(date) {
    const el = els.lastUpdated();
    if (!el) return;
    if (!date) { el.textContent = ''; return; }
    const ts = date.toLocaleString(undefined, {
      year:'numeric', month:'short', day:'2-digit',
      hour:'2-digit', minute:'2-digit', second:'2-digit'
    });
    el.textContent = `Last updated: ${ts}`;
  }

  // === Fetching ===
  async function fetchJsonWithTimeout(url, timeoutMs = 25000) {
    const ctl = new AbortController();
    const t = setTimeout(() => ctl.abort(), timeoutMs);
    const res = await fetch(url, { signal: ctl.signal, cache: 'no-store' });
    clearTimeout(t);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  async function tryAssetsQuery(page, limit, endpoint) {
    const qs = new URLSearchParams({
      collection_name: collection,
      template_id: templateId,
      page: String(page),
      limit: String(limit),
      order: 'asc',
      sort: 'asset_id'
    }).toString();
    const url = `${endpoint}/assets?${qs}`;
    return fetchJsonWithTimeout(url, 30000);
  }

  async function fetchAllAssetsWithFallback() {
    let workingBase = null;
    let firstPageData = null;

    for (const base of endpoints) {
      try {
        setStatus(`Checking ${new URL(base).host}…`);
        firstPageData = await tryAssetsQuery(1, PAGE_LIMIT, base);
        workingBase = base;
        setStatus(`Using ${new URL(base).host}`);
        break;
      } catch (e) {
        console.warn('Endpoint failed, trying next:', base, e?.message || e);
      }
    }
    if (!workingBase) throw new Error('All AtomicAssets endpoints failed.');

    const owners = {};
    let page = 1;

    while (page <= MAX_PAGES) {
      const data = page === 1 ? firstPageData : await tryAssetsQuery(page, PAGE_LIMIT, workingBase);
      const assets = data?.data || [];
      if (assets.length === 0) break;

      for (const a of assets) {
        const o = a.owner;
        if (o) owners[o] = (owners[o] || 0) + 1;
      }
      if (assets.length < PAGE_LIMIT) break;
      page++;
    }
    return owners;
  }

  // === Render ===
  function renderLeaderboard(countMap) {
    const sorted = Object.entries(countMap)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 100);

    const tbody = els.tbody();
    if (!tbody) return;
    tbody.innerHTML = '';

    if (sorted.length === 0) {
      const row = document.createElement('tr');
      row.innerHTML = `<td colspan="3" class="muted">No assets found for template ${templateId}.</td>`;
      tbody.appendChild(row);
      csvData = null;
      return;
    }

    sorted.forEach(([wallet, count], i) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${i + 1}</td>
        <td><a href="https://wax.atomichub.io/explorer/account/${wallet}" target="_blank" rel="noopener">${wallet}</a></td>
        <td class="num">${count}</td>`;
      tbody.appendChild(row);
    });

    csvData = sorted;
  }

  // === Orchestration ===
  async function fetchTopHolders() {
    const btn = els.refreshBtn();
    try {
      if (btn) { btn.disabled = true; btn.textContent = 'Refreshing…'; }
      setLoading(true);
      setStatus('Loading leaderboard…');
      setLastUpdated(null);

      const counts = await fetchAllAssetsWithFallback();
      renderLeaderboard(counts);

      setStatus('Ready');
      setLastUpdated(new Date());
    } catch (err) {
      console.error(err);
      setStatus('Error loading leaderboard. Click Refresh or hard refresh the page.');
      const tbody = els.tbody();
      if (tbody && !tbody.children.length) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="3" class="muted">Error fetching data.</td>`;
        tbody.appendChild(row);
      }
    } finally {
      setLoading(false);
      if (btn) { btn.disabled = false; btn.textContent = 'Refresh'; }
    }
  }

  function downloadCSV() {
    if (!csvData) return;
    let csv = "Rank,Wallet,Innfernos Held\n";
    csvData.forEach(([wallet, count], i) => {
      csv += `${i + 1},${wallet},${count}\n`;
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = Object.assign(document.createElement('a'), { href: url, download: 'innfernos_leaderboard.csv' });
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // Wire up
  document.addEventListener('DOMContentLoaded', () => {
    const r = els.refreshBtn();
    if (r) r.addEventListener('click', fetchTopHolders);
    const c = els.csvBtn();
    if (c) c.addEventListener('click', downloadCSV);
    fetchTopHolders();
  });
  </script>
</body>
</html>
